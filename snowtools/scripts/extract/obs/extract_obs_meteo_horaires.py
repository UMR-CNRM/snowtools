#! /usr/bin/env python
# -*- coding: utf-8 -*-

# Extraction des données d'observation depuis la BDCLIM
# Matthieu Lafaysse 10 sept 2014
# Script simplifié pour obtenir un format obs.csv depuis la BDCLIM

import sys, os
import string
import re
import datetime

import csv

from extract_obs import question 

def usage():
    print("USAGE extract_obs_meteo_horaires.py datedeb datefin dom")
    print("format des dates : YYYYMMDD")
    sys.exit(1)

stations_t = dict(
        alp = ["074136003","005096001","006077001","073157400","005077402","073143003","073307402","074014404","073176400","005161402","006127001","073034002","038191405","038472002","038253407","005063403","073206400","074083002","038253403","073194401","073227401","038469400","073280001","005098001","005063411","038285001","074063402","074080400","073123401","005101001","005161401","074258403","005157001","073261001","074191406","038005400","073173400","005031001","005119401","005139405","004100400","038567405","073257406","073232001","074014400","005096404","074058400","074014402","038567406","074063002","005061400","004099001","073304400","038021001","004019402","074191401","073054002","005114402","074173400","073290002","074238401","204012911","074063405","004006400","005026001","038395400","073023001","005101400","038191409","038006401","005139400","074134401","006073005","038002406","004019401","004073400","038472403","073150400","204042331","074056405","005001401","005181002","005077401","005001400","073318401","005072400","005079402","073301001","073322401","074286400","038527401","038375400","073144400","005023404","006163400","038191002","074056416","073257401","073040006","074085404","073123402","073257400","073132001","074056406","004096401","006116002","074056005","074014403","004062400","073306003","073187002","073304004","005085400","004193002","073023401","073280403","038442401","006070001","004019403","038289401","038020001","074058402","074215400","038163006","074136005","006094001","005023001","026059001","026142001","005183400","074056419","073055001","038285400","005114401","005058400","073056002","038052400","074085001","005098402","074136402","073290400","005098401","005093402","005079400","038472400","005114400","006094401","073040402","005093001","074290400","038375403","074190400","074056420","074080401","005161400","038395404","004205400","004019400","073296400","038375001","005023403","073024401","038253401","073123400","038567407","006120002","074058403","074266001","005026400","073257405","038005402","074014401","073296401","204070411","004006401","038191402","038020400","073306403","074056013","005064403","005063407","038090400","026059400","074056015","038567002","006119001","074056017","074056415","038548402","005157003","005098400","074258002","038002404","074173401","005085403","073071401","004006006","073157002","006056400","006163005","005110400","038472401","073206003","005096003","073318400","074033400","038469001","073242001","073296002","073071400","038527400","005093403","026074001","005064400","073024400","073004401","073296005","204041101","073230002","006073401","073054401","073015400","005120002","073306404","074134002","005177400","204010221","026168001","074276400","038567404","038548401","038207001","005007001","006056001","073098001","073304008","074238400","005063410","038005001","038186001","073034400","004019001","038020401","038187400","038527001","038548400","038514400","038205400","005132001","073132402","074191003","073176401","005093003","074258400","074085406","038191408","004193008","073015401","005085001","005079001","073306401","074208004","073235400","073150401","074190401","073093001","005096402","073194005","006153400","005183001","074183400","073175001","038040001","074080002","074187001","074085400","038191401","073004400","005145002","006163401","073047401","005119403","006120402","005027001","038002400","073173401","073257001","073047402","073307400","073054402","073235401","038191400","005119402","005027401","005182001","073280402","074191403","038128001","005139406","038375402","038253400","073232400","073194400","026290400","074056014","204040011","006073405","074056403","005063404","073054407","006120400","073144404","038002401","004173001","073144405","038522001","074056417","038548403","004193401","006056005","073197001","005177402","073306005","004006403","074032401","004193400","074236404","038264400","074191400","038548003","005101003","004115001","038366001","073304402","074063400","073034008","074056409","005063003","073034401","006077006","074063404","005177401","038021400","074173001","074056402","005110001","073138002","005096400","073322400","074063406","004096001","005038001","004019404","005110401","005063406","005063402","073038400","073040400","073040005","204010222","074279400","005120401","038253404","074037002","006127400","073139401","074136400","073132403","074236401","005027002","074134400","005133400","074085403","073071402","005004001","073071404","073071405","006094002","073206402","074033401","074236405","005064001","073304405","004205001","074080403","074270400","073157401","004006004","005044400","004226001","074056400","038442001","073304404","073221001","038269004","004136001","005096401","074191404","006120403","005096403","074056401","005139006","005157400","006094400","073026001","038186400","073132400","005007400","038002405","004100401","005058001","038006400","038186401","005114002","005085402","074056418","073232401","038395403","073013001","006073400","073232004","074191001","005090002","204011751","073244001","074143003","074034001","074032400","073227400","038439400","038548001","005026401","073071403","073206001","073132003","038442400","006016001","006120401","073296406","038264401","074290002","038567400","073206401"],
        pyr = ["065032001","066095001","064320404","065388406","066147402","203000404","203025029","203000446","031508401","203000444","203017018","065099400","064316400","203000451","065138005","065388405","065388001","099130406","031085400","065192006","065295400","009139400","009140001","065077401","031221401","009139001","099130414","009032400","065192001","009024004","031042400","203000465","065138401","203000406","099130410","065295004","066082001","099130404","009032001","009070401","203025064","009231401","066004400","064320403","009231400","064320402","064330400","203000460","031042012","066181001","203000400","009135401","066124401","009070400","064542400","009193400","203017010","066081002","009032401","203000455","099130411","099130425","066119002","009290400","066188400","066204400","066005004","203000452","065188403","031221400","099130421","065138001","065099402","065017404","064320406","203025045","065188402","066124400","065017401","203000462","065388403","203000467","009206401","009029402","203000459","031042001","203000410","066125003","031042401","099130408","009029001","203000403","099130412","064320401","064316001","099130423","066188401","066124402","065388400","065099401","099130402","065017002","009023401","066067402","066157001","065188003","203025046","065032004","203017014","065031001","066194002","064320400","066082400","065199401","065413400","066206002","203000408","009285400","066062001","064316002","099130405","099130426","009029401","099130413","099130429","203000407","065258400","065017403","203000405","009193401","064336400","064320405","065059403","066155001","066005001","099130416","203000402","065329400","066183001","065199400","066147400","031042404","099130015","065195001","031042407","066004401","099130424","065295401","203000461","203000409","066220002","066082401","064040400","066146002","099130401","009182003","009206002","066067400","065481401","009029400","009206001","203000447","065138400","009139402","203000458","031404001","066117001","065481400","099130415","065138402","065059400","009135400","031085401","009032402","065188400","064040401","031508400","065258001","203000445","066154401","031042405","065282003","009283002","066122001","064320001","009206400","009023400","031123005","009220004","203000476","203000449","009162001","065059401","066147401","065077400","065283001","065388402","066124004","099130427","009290004","099130403","009139401","031123400","099130409","099130428","065188401","065006001","203000466","066082004","065017400","203000468","031042403","203000483","066020400","066147001","203000448"],
        cor = ["020359004","020007402","020124400","020124001","020254400","020007401","020031400","020108002","020160001","020023401","020266001","020341400","020023400","020007400","020124402","020341001","020040003","020047001","020124401","020040400","020031001","020031401"]
    )


if __name__ == "__main__":

    if len(sys.argv) != 4:
        usage()
    datedeb = sys.argv[1] + "06"
    datefin = sys.argv[2] + "06"
    dom = sys.argv[3] 

    # II.1.1 construction de la question pour les postes nivo pour la HTN
    # ---------------------------------------------------------------------------
    # On prend toutes les heures

    question1 = question("question_t_hor.q")
    question1.set_fileout("obs_T_horaires_{0:s}.data".format(dom))
    question1.set_varout(["dat", "h.num_poste", "poste.nom_usuel", "poste.alti", "t"])
    question1.set_tables(["H", "POSTE"])
    question1.set_joincondition("H.NUM_POSTE = POSTE.NUM_POSTE and POSTE.NUM_POSTE in (" + ','.join(stations_t[dom]) + ')')
    question1.set_period(datedeb, datefin)
    question1.set_order(["h.num_poste", "dat"])
    question1.run()
