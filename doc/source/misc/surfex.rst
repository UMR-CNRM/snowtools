Few informations on SURFEX-Crocus simulations
=============================================

Basics of a SURFEX-Crocus simulation
------------------------------------

The steps of a SURFEX-Crocus simulation are :

* **PGD**: build physiography files (grid system, soil and vegetation properties, and all main parameters which are constant over time)
* **PREP**: build initial conditions for all model variables (e.g. all soil and snow state variables)
* **OFFLINE**: compute evolution of the state variables (soil, snow, etc.) in offline mode (forced by meteorological conditions).

The **PGD** step is the definition of the physiography for the ground.
It uses specific files (eg ecoclimapI_covers_param.bin) which gives an ecosystem classification with a coherent set of land surface parameters. You can have more info about ecoclimap: https://opensource.umr-cnrm.fr/projects/ecoclimap/wiki

The **PREP** step is the definition of initial values for all model state variables (for soil, snow, etc.). You can either:
- use a PREP_YYYYMMDDHH.nc file already produced by a previous simulation
- use a init_TG file providing initial ground temperatures). In that case, your simulation starts without snow on the ground.
- build an init_TG file from the air temperature climatology (computed from the meteorological forcing files)

The **OFFLINE** step is the simulation of the snow cover between the two dates of the simulation. It must have a meteorological file for that : the FORCING file.

Input files
-----------

What is needed to launch a SURFEX-Crocus simulation ?

- files to define the PGD (some of them are included in SURFEX package, some of them have to be downloaded from the SURFEX website: http://www.umr-cnrm.fr/surfex//spip.php?rubrique14 depending on your application)
- FORCING file for the near-surface meteorological conditions during the simulation.
- PREP file (or possibly create an init_TG file from the FORCING if you don’t have a PREP)
- two dates : begin of the simulation, end of the simulation
- namelist : a fortran ascii file which describes the physical options you want to apply for your simulation

Details on PREP files
^^^^^^^^^^^^^^^^^^^^^
NB : if you run a simulation in an already existing output directory (via the -o option), the simulation will use the PREP file available in output/prep folder. This is necessary to extend simulations in time, or to perform sensitivity analyses using identical initial conditions.

The initialisation of SURFEX state variables is associated with a date. So, the file is named PREP_YYYYMMDDHH.nc

If you are starting a simulation with a PREP_YYYYMMDDHH.nc file :

- the date should be consistent with the starting date of the simulation.
- the state of the soil / snow must be consistent with the options of your simulation. For example, if your PREP_YYYYMMDDHH.nc file comes from a simulation without impurity, it can’t be used for a simulation with impurity. Similarly the PREP files must have been generated by a simulation using the same number of soil and snow layers than the incoming one.
- at the end of the simulation, the resulting state of the soil / snow properties for the ending date is written in another PREP_YYYYMMDDHH.nc which can be used for a future simulation restarting at this date.

NB : When necessary, is possible to use a « false date » PREP_YYYYMMDDHH.nc file to start a simulation (see ``s2m research --help``)


Launch simulations
------------------
Snowtools is a library made for launching simulations, pre or post processing simulations, visualise simulations. The launching command is ``s2m`` provided by snowtools package. Run ``s2m research --help`` for details.

Results
-------
After the first test, there is a folder named « output » (or another name if you change the -o option of the s2m command) which is created. This folder contains 5 subfolders:

- **meteo** :
  for the meteorological FORCING. It is only used to save forcing files in cases they are modifie through the s2m command (e.g. geometry changes, etc.)
- **prep** :
  for PGD and PREP files. After the simulation, it contains:
  - the PGD.nc file
  - a init_TG.nc file if there were no PREP file at the beginning of the simulation (this is the case for the first test)
  - a PREP_2010080106.nc file : state of snow cover for starting date
  - a PREP_2011080106.nc file : state of snow cover for ending date
- **pro** :
    This folder contains the result of the simulation : PRO_2010080106_2011080106.nc file proving all simulation diagnostics for the whole simulation period.
    Output diagnostics should be defined in the namelist to adjust the output volume to what you really need (this is the CSELECT choice in the namelist).

Running directories
All computations are performed in dedicated running directories that you should not need to modify yourself or even access for regular simulations.
However, these directories can contain useful informations to understand the origin of unexpected bugs.

- **workClim**:
    This directory is used to compute soil initialization files based on air temperature climatology.
- **workSurfex**:
    This directory is used for all the main computations of the simulation. It can be used to identify all input files used in an aborted or suspicous execution, as well as some log files produced by SURFEX useful to investigate bugs. Note that during the execution process, the files initially provided with dates (for PREP and FORCING) are renamed PREP.nc and FORCING.nc with symbolic links as OFFLINE execution only opens 'PGD.nc', 'PREP.nc' and 'FORCING.nc'

The CSELECT options
-------------------

In the namelist, CSELECT allows you to choose output. For example, in the standard namelist, you have:
``CSELECT='time','ZS','aspect','slope','massif_num','station','TG1','WG1','WGI1','TG4','ASN_VEG'...``

Here you can find long name for a part of these variables (alphabetical order for shortname):

- ASN_VEG = Albedo
- DRAIN_ISBA = Subsurface_runoff_flux
- DSN_T_ISBA = Thickness_of_snowfall_amount
- EVAP_ISBA = Surface_water_evaporation_flux
- GFLUX_ISBA = Ground flux over tile nature
- H_ISBA = Surface_upward_sensible_heat_flux
- LE_ISBA = Surface_upward_latent_heat_flux
- LWD_ISBA = Surface_downwelling_longwave_flux_in_air
- LWU_ISBA = Surface_upwelling_longwave_flux_in_air
- MMP_VEG = Cumulative water consumption for snowmaking (kg/m2)
- RAINF_ISBA = Rainfall_flux
- RAMSOND_ISBA = Penetration of ram resistance sensor
- REFRZTH_ISBA = Thickness of refrozen snow at the top of the snowpack
- RN_ISBA = Surface_net_downward_radiative_flux
- RSN_VEG = Snow Density (kg/m3)
- RUNOFF_ISBA = Surface_runoff_flux
- SAG_VEG = Snow Age (days)
- SD_1DY_ISBA = Accumulated snow thickness for past 1 days
- SD_3DY_ISBA = Accumulated snow thickness for past 3 days
- SD_5DY_ISBA = Accumulated snow thickness for past 5 days
- SD_7DY_ISBA = Accumulated snow thickness for past 7 days
- SNOWDEND = Dendricity
- SNOWDZ = Thickness (m)
- SNOWGRAN1 = Optical diameter (m)
- SNOWGRAN2 = Sphericity
- SNOWHEAT = Snow Enthalpy (J/m2)
- SNOWLIQ = Snow Liquid Water Content (kg/m3)
- SNOMLT_ISBA = Snow melting rate
- SNOWRAM = RAM Resistance (daN)
- SNOWSHEAR = Shear Resistance (kPa)
- SNOWSIZE = Grain size (m)
- SNOWSPHER = Sphericity
- SNOWSSA = Snow SSA (specific surface area, m2/kg)
- SNOWTEMP = Temperature (K)
- SNOWTYPE = Grain type (EN)
- SWE_1DY_ISBA = Accumulated snow water equivalent for past 1 days
- SWE_3DY_ISBA = Accumulated snow water equivalent for past 3 days
- SWE_5DY_ISBA = Accumulated snow water equivalent for past 5 days
- SWE_7DY_ISBA = Accumulated snow water equivalent for past 7 days
- SWD_ISBA = Surface_downwelling_shortwave_flux_in_air
- SWU_ISBA = Surface_upwelling_shortwave_flux_in_air
- TALB_ISBA = Surface_albedo
- TG1 = Temperature of soil layer 1(depth 0.0050 m)
- TG4 = Temperature of soil layer 4(depth 0.0800 m)
- TS_ISBA = Surface_temperature
- WBT = Wet bulb temperature (°C)
- WET_TH_ISBA = Thickness of wet snow at the top of the snowpack
- WG1 = Liquid water content of soil layer 1(depth 0.0050 m)
- WGI1 = Solid water content of soil layer 1(depth 0.0050 m)
- WSN_T_ISBA = Surface_snow_amount = Total_snow_reservoir
- WSN_VEG = Snow Water Equivalent (m)

SNOWPAPPUS cumulated outputs: (MPI grid only)

- QDEP_TOT = total wind-blown snow net deposition rate q dep (kg.m −2 .s −1 )
- QT_TOT = total wind-blown horizontal vertically integrated snow transport rate Q t (kg.m −1 .s −1 )
- Q_OUT_SUBL = sublimation rate q subl (kg.m −2 .s −1 )
- SNOWDEBTC = cumulated amount of snow which should have been removed on the point but was not because it became snow-free (kg.m −2 )

SNOWPAPPUS instantaneous outputs:

- BLOWSNWFLUX_1M = horizontal blowing snow flux 1 m above snow surface (kg.m −2 .s −1 )
- BLOWSNWFLUXINT = average horizontal blowing snow flux between 0.2 and 1.2 m Q t,int (kg.m −1 .s −1 )
- Q_OUT_SALT = total horizontal transport rate in the saltation layer Q salt (kg.m −1 .s −1 )
- Q_OUT_SUSP = total horizontal transport rate in the suspension layer Q susp (kg.m −1 .s −1 )
- XVFRIC_PAPPUS = wind friction velocity computed by Snowpappus u ∗ (m.s −1 )
- XVFRIC_T_PAPPUS = threshold friction velocity (at ground level) for snow transport u ∗,t (m.s −1 )
- XPZ0_PAPPUS = roughness length for momentum z 0 (m) used by Snowpappus
- XVFALL_PAPPUS = mass averaged terminal fall velocity of snow particles at the bottom of the suspension layer v f (m.s −1 )
- SNFLX_1M_P = snow transport flux integrated up to 1m height
- SNFLXINT_P = snow transport flux integrated on height


Impurities explicit:
- SNOWIMP1 = Concentration of Soot (g/g)
- SNOWIMP2 = Concentration of Dust (g/g)
- SPEC_TOT = Total incident spectral radiation (unit ?) over 186 spectral bands (300, 320, ..., 4000 nm)
- SPEC_ALB = Snow spectral albedo over 186 spectral bands (300, 320, ..., 4000 nm)
- DIFF_RATIO = Diffuse to total spectral irradiance ratio

You can find other variables in SURFEX documentation:
https://www.umr-cnrm.fr/surfex/spip.php?article30
